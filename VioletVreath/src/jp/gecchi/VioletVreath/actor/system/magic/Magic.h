#ifndef MAGIC_H_
#define MAGIC_H_
namespace VioletVreath {

typedef int magic_point;
typedef frame magic_time;

#define MAGIC_CAST_NG_INVOKING_NOW          (-3)
#define MAGIC_CAST_NG_MP_IS_SHORT           (-2)
#define MAGIC_CAST_CANCEL                   (-1)
#define MAGIC_CAST_NOTHING                  (0)
#define MAGIC_CAST_OK_LEVELUP               (1)
#define MAGIC_CAST_OK_LEVELDOWN             (2)
#define MAGIC_CAST_OK_CANCEL_AND_LEVELUP    (3)
#define MAGIC_CAST_OK_CANCEL_AND_LEVELDOWN  (4)

#define MAGIC_INVOKE_NG_INVOKING_NOW (-3)
#define MAGIC_INVOKE_NG_MP_IS_SHORT (-2)
#define MAGIC_INVOKE_NOTHING        (0)
#define MAGIC_INVOKE_OK_LEVELUP     (1)
#define MAGIC_INVOKE_OK_LEVELDOWN   (2)

#define MAGIC_EFFECT_NG_MP_IS_SHORT (-2)
#define MAGIC_EFFECT_NOTHING        (0)
#define MAGIC_EFFECT_OK_LEVELUP     (1)
#define MAGIC_EFFECT_OK_LEVELDOWN   (2)

enum {
    MAGIC_STATE_NOTHING = 1,
    MAGIC_STATE_STAND_BY   ,
    MAGIC_STATE_CASTING    ,
    MAGIC_STATE_INVOKING   ,
    MAGIC_STATE_EFFECT_BEGEIN,
    MAGIC_STATE_EFFECTING  ,
    MAGIC_STATE_ABANDONING ,
};


/**
 * 抽象魔法クラス .
 * 魔法とMPについての本クラスの基本的な約束事。<BR>
 * ・魔法を使用すると各く魔法に設定されたMPを消費します。これを「基本魔法コスト」呼びます。<BR>
 * ・魔法にはレベルという概念があり、基本的にレベルを＋１するのに「基本魔法コスト」が消費されます。<BR>
 *   但し、飛びレベル(＋２以上)の場合、MP消費を割安にする設定が出来ます。<BR>
 *   たとえば「スピード」と言う魔法にレベル１〜５があり、基本魔法コストは 10 だったとします。<BR>
 *   「スピード Level1」＞「スピード Level2」 とした場合、MPコストは 10+10=20 ですが、<BR>
 *   いきなり「スピード Level2」とした場合、MPコストは (10+10)*0.8 = 16 という設定が可能です。<BR>
 *   この 0.8 のことを「削減割合」と呼ぶ事とします。<BR>
 * ・レベルダウンの概念が存在します。レベルダウンはいつでも行えます。<BR>
 *   レベルダウン時にその分をMPに幾らか戻すという設定も出来ます。<BR>
 * ・魔法にはライフサイクルがあり、次のステップが存在します。各パラメータが設定可能です。<BR>
 *   a) 魔法のレベルアップ実行<BR>
 *   b) 詠唱：魔法詠唱開始・詠唱中・詠唱終了<BR>
 *   c) 発動：魔法発動開始(コスト発生) ・魔法中・魔法終了<BR>
 *   d) 持続：魔法効果持続開始(効果発生) ・効果持続中・果持続終了<BR>
 *   e) 魔法のレベルダウン<BR>
 * ・「b) 詠唱」までならば破棄（停止）が可能です。<BR>
 *   「c) 発動」までステップが進むと、MPが消費され途中破棄は不可能になります。<BR>
 *   「d) 持続」になるまで、レベルアップ、レベルダウンの操作は出来ないこととします。<BR>
 * ・魔法には、維持コスト有り、維持コスト無し、の２種類があります。<BR>
 *   維持コスト有りは、「d) 持続」中にMPを消費します。<BR>
 *   その後、設定された効果持続時間を超えると自動でレベルダウンします。<BR>
 *   さらに、途中でMPが枯渇した場合は、強制的にレベル０になります。<BR>
 *   維持コスト無しは、「d) 持続」中にMPを消費しません。<BR>
 *   その後、設定された効果持続時間を超えると自動でレベルダウンしますが、<BR>
 *   MPが枯渇してもレベルダウンしません。<BR>
 * @version 1.00
 * @since 2009/05/19
 * @author Masatoshi Tsuge
 */
class Magic : public GgafCore::GgafMainActor {


public:
    /**
     * 各レベルの情報 .
     */
    class LevelInfo {
    public:
        /** [r]該当レベルで魔法が適用中であるかどうか(発動開始〜効果終了までtrue) */
        bool is_working_;
        /** [r]魔法効果持続終了残り時間 */
        magic_time remainingtime_of_effect_;
        /** [r/w]魔法効果持続時間 */
        magic_time time_of_effect_;
        /** [r/w]魔法効果持続中コスト  */
        magic_point keep_cost_;
        /** [r/w]アニメパターン番号 */
        int pno_;

        LevelInfo() : is_working_(false),
                      remainingtime_of_effect_(0),
                      keep_cost_(0),
                      pno_(0) {
        }
    };

    /** [r]最高上限レベル */
    int max_level_;
    /** [r]現在のレベル */
    int level_;
    /** [r]新しいレベル */
    int new_level_;
    /** [r]前回のレベル */
    int last_level_;


    /** [r]マジックポイント数量バー */
    GgafLib::AmountGraph* pMP_;
    /** [r]メーターへのポインタ */
    MagicMeter* pMagicMeter_;

    /** [r]各レベルの情報 0〜MMETER_MAX_LEVEL */
    LevelInfo lvinfo_[MMETER_MAX_LEVEL+1];
    /** [r]飛びレベル差別魔法コスト情報 0差〜MMETER_MAX_LEVEL差 */
    magic_point interest_cost_[MMETER_MAX_LEVEL+1];
    /** [r]飛びレベル差別詠唱時間情報 0差〜MMETER_MAX_LEVEL差 */
    magic_time  interest_time_of_casting_[MMETER_MAX_LEVEL+1];
    /** [r]飛びレベル差別発動時間情報 0差〜MMETER_MAX_LEVEL差 */
    magic_time  interest_time_of_invoking_[MMETER_MAX_LEVEL+1];

    /** [r]本魔法発動に必要なコストの基本単位 */
    magic_point cost_base_;
    /** [r]本魔法詠唱開始 〜 魔法詠唱終了の基本単位時間  */
    magic_time time_of_casting_base_;
    /** [r]本魔法発動開始 〜 魔法発動終了の基本単位時間 */
    magic_time time_of_invoking_base_;
    /** [r]本魔法効果持続開始 〜 魔法効果持続終了の基本単位時間  */
    magic_time time_of_effect_base;
    /** [r]本魔法効果持続中コストの基本単位  */
    magic_point keep_cost_base_;

    /** [r]飛びレベル時の魔法コスト削減割合(0.0〜1.0) */
    float fRate_cost_;
    /** [r]飛びレベル時の詠唱時間削減割合(0.0〜1.0) */
    float fRate_time_of_casting_;
    /** [r]飛びレベル時の発動時間削減割合(0.0〜1.0) */
    float fRate_time_of_invoking_;
    /** [r]各レベル毎の効果持続時間削減割合(0.0〜1.0) */
    float fRate_time_of_effecting_;
    /** [r]各レベル毎の維持コスト増加割合 (1.0〜 )*/
    float fRate_keep_cost_;

    /** [r]次の進捗状態になる為に必要なフレーム数(を一時保持) */
    magic_time time_of_next_state_;
    /** [r]レベルアップ中かどうか */
    bool is_working_;


public:

    /**
     * 魔法の定義を行う .
     * 飛びレベルとはレベル差が１より大きい(レベル差２以上)を指す。
     * @param prm_name 魔法名
     * @param prm_pMP マジックポイントの数量バー
     * @param prm_max_level 本魔法の最高レベル 1〜MMETER_MAX_LEVEL
     * @param prm_cost_base 基本魔法コスト
     * @param prm_fRate_cost 飛びレベル時の魔法コスト削減割合 0.0〜1.0 (1.0:飛びレベルでも割引無し、0.8:レベル差２以上時、魔法コスト２割引)
     * @param prm_time_of_casting_base 基本魔法詠唱時間
     * @param prm_fRate_time_of_casting 飛びレベル時の詠唱時間削減割合0.0〜1.0 (1.0:飛びレベルでも割引無し, 0.8:レベル差２以上時、詠唱時間２割引)
     * @param prm_time_of_invoking_base 基本魔法発動時間
     * @param prm_fRate_time_of_invoking 飛びレベル時の発動時間削減割合0.0〜1.0 (1.0:飛びレベルでも割引無し, 0.8:レベル差２以上時、発動時間２割引)
     * @param prm_time_of_effect_base 基本魔法効果持続時間
     * @param prm_fRate_time_of_effecting 各レベル毎の効果持続時間削減割合  0.0〜1.0
     *                            (1.0:レベルによる効果持続時削減無し,
     *                            (0.8:レベル1のとき prm_time_of_effect
     *                                 レベル2のとき prm_time_of_effect * 0.8
     *                                 レベル3のとき prm_time_of_effect * 0.8 * 0.8
     *                                 レベル4のとき prm_time_of_effect * 0.8 * 0.8 * 0.8  という持続時間が設定される)
     * @param prm_keep_cost_base 基本魔法効果持続中維持コスト
     * @param prm_fRate_keep_costbase 各レベル毎の維持コスト増加割合 1.0〜
     *                            (1.0:レベルによる維持コスト増加無し,
     *                            (1.2:レベル1のとき prm_keep_cost_base
     *                                 レベル2のとき prm_keep_cost_base * 1.2
     *                                 レベル3のとき prm_keep_cost_base * 1.2 * 1.2
     *                                 レベル4のとき prm_keep_cost_base * 1.2 * 1.2 * 1.2  という維持コストが設定される)
     * @return
     */
    Magic(const char* prm_name, GgafLib::AmountGraph* prm_pMP,
          int   prm_max_level,
          magic_point prm_cost_base, float prm_fRate_cost,
          magic_time  prm_time_of_casting_base , float prm_fRate_time_of_casting,
          magic_time  prm_time_of_invoking_base, float prm_fRate_time_of_invoking,
          magic_time  prm_time_of_effect_base  , float prm_fRate_time_of_effecting,
          magic_point prm_keep_cost_base       , float prm_fRate_keep_costbase);

    void initialize() override {}

    void onReset() override {}

    void processBehavior() override;

    void processJudgement() override {}

    void processDraw() override {}

    void processFinal() override {}

    void onCatchEvent(hashval prm_no, void* prm_pSource) override {}

    void save(std::stringstream& sts);

    void load(std::stringstream& sts);

    /**
     * 詠唱開始実行 .
     * @param prm_new_level
     */
    virtual int cast(int prm_new_level);

    /**
     * 魔法詠唱開始コールバック(１回だけコールバック) .
     * @param prm_now_level 現在のレベル(0〜 )
     * @param prm_new_level 詠唱する新しいレベル(1〜 )
     */
    virtual void processCastBegin(int prm_now_level, int prm_new_level) {};

    /**
     * 魔法詠唱中コールバック(毎フレームコールバック) .
     * @param prm_now_level 現在のレベル(0〜 )
     * @param prm_new_level 詠唱中の新しいレベル(1〜 )
     */
    virtual void processCastingBehavior(int prm_now_level, int prm_new_level) {};

    /**
     * 魔法詠唱終了コールバック(１回だけコールバック) .
     * @param prm_now_level 現在のレベル(0〜 )
     * @param prm_new_level 詠唱中完了した新しいレベル(1〜 )
     */
    virtual void processCastFinish(int prm_now_level, int prm_new_level) {};

    /**
     * 発動開始実行 .
     * @param prm_new_level
     */
    virtual int invoke(int prm_new_level);

    /**
     * 魔法発動開始コールバック。ここまでくると詠唱キャンセルは不可とする。(１回だけコールバック) .
     * @param prm_now_level 現在のレベル(0〜 )
     * @param prm_new_level 発動させようとしている新しいレベル(1〜 )
     */
    virtual void processInvokeBegin(int prm_now_level, int prm_new_level) {};

    /**
     * 魔法発動中コールバック(毎フレームコールバック) .
     * @param prm_now_level 現在のレベル(0〜 )
     * @param prm_new_level 発動させようとしている新しいレベル(1〜 )
     */
    virtual void processInvokeingBehavior(int prm_now_level, int prm_new_level) {};

    /**
     * 魔法発動終了コールバック(１回だけコールバック) .
     * @param prm_now_level 発動中だった頃の、現在のレベル。(0〜 )
     * @param prm_new_level 発動により、これから昇格する新しいレベル。(1〜 )
     */
    virtual void processInvokeFinish(int prm_now_level, int prm_new_level) {};

    /**
     * 効果発揮実行 .
     * @param prm_level 効果発揮時レベル
     */
    virtual int effect(int prm_level);

    /**
     * 魔法効果持続開始コールバック(１回だけコールバック) .
     * 魔法発動終了 → 魔法効果持続開始、のタイミングで呼び出される。さらに、<BR>
     * 魔法効果持続中 → レベルアップ or レベルダウン、のタイミングでも呼び出される。<BR>
     * prm_last_level < prm_now_level の場合レベルアップ .
     * prm_last_level > prm_now_level の場合レベルダウン .
     * @param prm_last_level 効果持続が開始される前のレベル。(レベルアップ時：0〜 ／レベルダウン時：1〜)
     * @param prm_now_level 効果持続が開始されたレベル。(レベルアップ時：1〜 ／レベルダウン時：1〜)
     */
    virtual void processEffectBegin(int prm_last_level, int prm_now_level) {};

    /**
     * 魔法効果持続中コールバック(毎フレームコールバック) .
     * @param prm_last_level  以前のレベル。
     * @param prm_now_level 現在(持続中)のレベル。
     */
    virtual void processEffectingBehavior(int prm_last_level, int prm_now_level) {};

    /**
     * 魔法持続全終了コールバック(１回だけコールバック) .
     * レベル0になるレベルダウンが行われた直前に呼び出されます。<BR>
     * 捕捉：レベル0にならないレベルダウン processEffectBegin() が呼び出されます。<BR>
     * @param prm_justbefore_level 効果持続が終了する直前のレベル(ちなみに現在レベルは必ず0)。
     */
    virtual void processEffectFinish(int prm_justbefore_level) {};


    /**
     * そのレベルの魔法が詠唱実行できるか調べる
     * @param prm_new_level 詠唱するレベル
     * @return
     */
    int chkCastAble(int prm_new_level);

    /**
     * そのレベルの魔法が発動実行ができるか調べる
     * @param prm_new_level 発動するレベル
     * @return
     */
    int chkInvokeAble(int prm_new_level);

    /**
     * そのレベルの魔法が効果が実行ができるか調べる
     * @param prm_level
     * @return
     */
    int chkEffectAble(int prm_level);

    /**
     * 魔法をキャンセルする .
     */
    virtual void cancel();

    virtual ~Magic();
};

}
#endif /*MAGIC_H_*/
